<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 1: Infinite AI Workbook ‚Äì ÁõæÁõæÊó•ËØ≠</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=ZCOOL+XiaoWei&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --paper-width: 210mm;
            --paper-height: 297mm;
            --glass-border: rgba(255, 255, 255, 0.4);
            --glass-surface: rgba(255, 255, 255, 0.65);
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #cbd5e1 100%);
            min-height: 100vh;
            color: #1d1d1f;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 50px;
        }

        .glass-nav {
            background: var(--glass-surface);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            position: sticky;
            top: 20px;
            z-index: 50;
            width: 90%;
            max-width: 1000px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            margin-bottom: 3rem;
            margin-top: 1rem;
            border-radius: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05);
        }

        .test-page {
            width: var(--paper-width);
            height: var(--paper-height);
            background: white;
            padding: 20mm;
            margin-bottom: 60px;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        h1 {
            font-family: 'ZCOOL XiaoWei', serif;
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            text-align: center;
            color: #1e293b;
        }

        h2 {
            font-size: 1.2rem;
            font-weight: 700;
            border-bottom: 2px solid #cbd5e1;
            padding-bottom: 0.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: #334155;
        }

        h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #64748b;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .grid-5 {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .question-box {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fff;
            position: relative;
            transition: all 0.3s ease;
            min-height: 80px;
        }

        .question-box.checking {
            border-color: #fbbf24;
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.3);
        }

        .question-box.correct-ai {
            border-color: #22c55e;
            background-color: #f0fdf4;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
        }

        .question-box.incorrect-ai {
            border-color: #ef4444;
            background-color: #fef2f2;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }

        .question-box.wide {
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1.5rem;
        }

        .label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 0.5rem;
            z-index: 10;
        }

        .question-box.wide .label {
            margin-bottom: 0;
        }

        input[type="text"] {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.5rem;
            width: 100%;
            text-align: center;
            font-size: 1.2rem;
            outline: none;
            font-family: 'Noto Sans JP', sans-serif;
            z-index: 20;
            background: rgba(255, 255, 255, 0.9);
        }

        .question-box.wide input {
            width: 50%;
        }

        input:focus {
            border-color: #6366f1;
        }

        /* Canvas & AI Overlay */
        canvas.handwriting-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 15;
            cursor: crosshair;
            touch-action: none;
            border-radius: 12px;
            display: none;
        }

        .ghost-answer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Yuji Syuku', serif;
            font-size: 2.5rem;
            color: #ef4444;
            opacity: 0;
            pointer-events: none;
            z-index: 5;
            transition: opacity 0.5s;
        }

        .question-box.wide .ghost-answer {
            left: 75%;
            font-size: 2rem;
        }

        .page-number {
            position: absolute;
            bottom: 15mm;
            left: 0;
            right: 0;
            text-align: center;
            color: #94a3b8;
            font-size: 0.8rem;
        }

        @media print {
            body {
                background: none;
                display: block;
                padding: 0;
            }

            .glass-nav {
                display: none !important;
            }

            .test-page {
                box-shadow: none;
                margin: 0;
                page-break-after: always;
                width: 100%;
                height: 100%;
            }

            input {
                border: none;
                border-bottom: 1px solid #000;
            }
        }

        /* Mode Switching */
        body.mode-handwriting input {
            display: none;
        }

        body.mode-handwriting canvas {
            display: block;
        }

        body.mode-handwriting .question-box {
            border: 1px dashed #cbd5e1;
            height: 100px;
        }

        body.mode-handwriting .question-box.wide {
            height: auto;
            min-height: 80px;
        }

        /* Spinner */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #6366f1;
            animation: spin 1s linear infinite;
            display: none;
        }

        #ai-status-loader {
            display: none;
        }

        /* Result Icons */
        .result-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1.5rem;
            z-index: 25;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            0% {
                transform: scale(0);
            }

            100% {
                transform: scale(1);
            }
        }
    </style>
</head>

<body class="mode-typing">

    <nav class="glass-nav no-print">
        <div class="flex items-center gap-4">
            <a href="chapter1.html"
                class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg hover:scale-105 transition">‚Üê</a>
            <div>
                <h2 class="text-sm font-bold text-slate-800 m-0 border-none p-0 mt-0">Infinite Workbook</h2>
                <span class="text-[10px] text-slate-500 uppercase tracking-widest">Random & AI</span>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <button onclick="remixTest()"
                class="px-3 py-2 bg-pink-100 text-pink-700 rounded-lg hover:bg-pink-200 transition text-sm font-bold flex items-center gap-2">
                üé≤ Remix Test
            </button>
            <div class="h-8 w-px bg-slate-200 mx-2"></div>
            <button onclick="setMode('typing')" id="btn-typing"
                class="px-3 py-1 rounded-lg text-sm font-bold bg-indigo-100 text-indigo-700 transition">‚å®Ô∏è Type</button>
            <button onclick="setMode('handwriting')" id="btn-writing"
                class="px-3 py-1 rounded-lg text-sm font-bold text-slate-400 hover:text-slate-600 transition">‚úçÔ∏è
                Write</button>
        </div>

        <div class="flex items-center gap-2">
            <button onclick="gradeVisual()"
                class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-full font-bold text-sm transition"
                title="Show Correct Answer">
                üëÄ Answer
            </button>

            <button onclick="gradeWithAI()"
                class="px-5 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-full font-bold shadow-lg flex items-center gap-2 transition text-sm">
                <span id="ai-icon">‚ú®</span> AI Check
                <div id="ai-status-loader" class="spinner w-4 h-4 border-2"></div>
            </button>

            <button onclick="window.print()"
                class="w-10 h-10 rounded-full bg-slate-800 text-white flex items-center justify-center hover:bg-slate-700">üñ®Ô∏è</button>
        </div>
    </nav>

    <div id="ai-message"
        class="hidden fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-black/80 text-white px-6 py-3 rounded-full shadow-2xl z-50 text-sm font-bold animate-pulse">
        ü§ñ AI is analyzing your handwriting...
    </div>

    <form id="test-form">

        <!-- PAGE 1: HIRAGANA (A-NA) RANDOM -->
        <article class="test-page">
            <h1>Hiragana Part 1</h1>
            <p class="text-center text-slate-400 mb-8">Basic Sounds (Randomized A-Na)</p>
            <div class="flex-grow flex flex-col gap-6" id="page-1-content">
                <!-- Injected via JS -->
            </div>
            <div class="page-number">1 / 8</div>
        </article>

        <!-- PAGE 2: HIRAGANA (HA-N) RANDOM -->
        <article class="test-page">
            <h1>Hiragana Part 2</h1>
            <p class="text-center text-slate-400 mb-8">Basic Sounds (Randomized Ha-N)</p>
            <div class="flex-grow flex flex-col gap-6" id="page-2-content">
                <!-- Injected via JS -->
            </div>
            <div class="page-number">2 / 8</div>
        </article>

        <!-- PAGE 3: KATAKANA (A-NO) RANDOM -->
        <article class="test-page">
            <h1>Katakana Part 1</h1>
            <p class="text-center text-slate-400 mb-8">Hiragana -> Katakana (Randomized A-No)</p>
            <div class="flex-grow flex flex-col gap-6" id="page-3-content">
                <!-- Injected via JS -->
            </div>
            <div class="page-number">3 / 8</div>
        </article>

        <!-- PAGE 4: KATAKANA (HA-N) RANDOM -->
        <article class="test-page">
            <h1>Katakana Part 2</h1>
            <p class="text-center text-slate-400 mb-8">Hiragana -> Katakana (Randomized Ha-N)</p>
            <div class="flex-grow flex flex-col gap-6" id="page-4-content">
                <!-- Injected via JS -->
            </div>
            <div class="page-number">4 / 8</div>
        </article>

        <!-- PAGE 5: DAKUON MIX (Hiragana & Katakana) -->
        <article class="test-page">
            <h1>Voiced Sounds (Mix)</h1>
            <p class="text-center text-slate-400 mb-8">Dakuon / Handakuon Challenge</p>
            <div class="flex-grow flex flex-col gap-6" id="page-5-content">
                <!-- Injected via JS -->
            </div>
            <div class="page-number">5 / 8</div>
        </article>

        <!-- PAGE 6: YOON & SOKUON -->
        <article class="test-page">
            <h1>Combo Sounds</h1>
            <p class="text-center text-slate-400 mb-8">Yoon & Sokuon (Cha, Shu, Kyo...)</p>
            <div class="flex-grow flex flex-col gap-6" id="page-6-content">
                <!-- Injected via JS -->
            </div>
            <div class="page-number">6 / 8</div>
        </article>

        <!-- PAGE 7: VOCABULARY -->
        <article class="test-page">
            <h1>Vocabulary Challenge</h1>
            <p class="text-center text-slate-400 mb-8">Random Selection from Chapter 1</p>
            <div class="grid-2 w-full gap-4" id="page-7-content">
                <!-- Injected via JS -->
            </div>
            <div class="page-number">7 / 8</div>
        </article>

        <!-- PAGE 8: MASTERY -->
        <article class="test-page">
            <h1>Final Mastery</h1>
            <p class="text-center text-slate-400 mb-8">Particles & Final Check</p>
            <div class="flex-grow flex flex-col justify-center items-center gap-12">
                <div class="w-full bg-slate-50 p-6 rounded-2xl border border-slate-200">
                    <h3 class="text-center mb-6">Particle Challenge</h3>
                    <div id="page-8-content" class="flex flex-col gap-4 items-center">
                        <!-- JS -->
                    </div>
                </div>

                <div class="text-center">
                    <h2 class="border-none mb-4">Complete Chapter 1</h2>

                    <button type="button" onclick="gradeVisual(); window.print();"
                        class="px-10 py-4 bg-indigo-600 text-white font-bold rounded-full shadow-xl hover:scale-105 transition no-print text-lg">
                        Submit & Print
                    </button>
                </div>
            </div>
            <div class="page-number">8 / 8</div>
        </article>

    </form>

    <script>
        const API_KEY = "AIzaSyANEpdPzKlnII7-Xzp2bJvBFJitPD1AEdY";
        let currentMode = 'typing';

        const HIRAGANA_BASIC = [
            { a: '„ÅÇ', l: 'A' }, { a: '„ÅÑ', l: 'I' }, { a: '„ÅÜ', l: 'U' }, { a: '„Åà', l: 'E' }, { a: '„Åä', l: 'O' },
            { a: '„Åã', l: 'Ka' }, { a: '„Åç', l: 'Ki' }, { a: '„Åè', l: 'Ku' }, { a: '„Åë', l: 'Ke' }, { a: '„Åì', l: 'Ko' },
            { a: '„Åï', l: 'Sa' }, { a: '„Åó', l: 'Shi' }, { a: '„Åô', l: 'Su' }, { a: '„Åõ', l: 'Se' }, { a: '„Åù', l: 'So' },
            { a: '„Åü', l: 'Ta' }, { a: '„Å°', l: 'Chi' }, { a: '„Å§', l: 'Tsu' }, { a: '„Å¶', l: 'Te' }, { a: '„Å®', l: 'To' },
            { a: '„Å™', l: 'Na' }, { a: '„Å´', l: 'Ni' }, { a: '„Å¨', l: 'Nu' }, { a: '„Å≠', l: 'Ne' }, { a: '„ÅÆ', l: 'No' },
            { a: '„ÅØ', l: 'Ha' }, { a: '„Å≤', l: 'Hi' }, { a: '„Åµ', l: 'Fu' }, { a: '„Å∏', l: 'He' }, { a: '„Åª', l: 'Ho' },
            { a: '„Åæ', l: 'Ma' }, { a: '„Åø', l: 'Mi' }, { a: '„ÇÄ', l: 'Mu' }, { a: '„ÇÅ', l: 'Me' }, { a: '„ÇÇ', l: 'Mo' },
            { a: '„ÇÑ', l: 'Ya' }, { a: '„ÇÜ', l: 'Yu' }, { a: '„Çà', l: 'Yo' },
            { a: '„Çâ', l: 'Ra' }, { a: '„Çä', l: 'Ri' }, { a: '„Çã', l: 'Ru' }, { a: '„Çå', l: 'Re' }, { a: '„Çç', l: 'Ro' },
            { a: '„Çè', l: 'Wa' }, { a: '„Çí', l: 'Wo' }, { a: '„Çì', l: 'N' }
        ];

        const KATAKANA_BASIC = [
            { a: '„Ç¢', l: '„ÅÇ' }, { a: '„Ç§', l: '„ÅÑ' }, { a: '„Ç¶', l: '„ÅÜ' }, { a: '„Ç®', l: '„Åà' }, { a: '„Ç™', l: '„Åä' },
            { a: '„Ç´', l: '„Åã' }, { a: '„Ç≠', l: '„Åç' }, { a: '„ÇØ', l: '„Åè' }, { a: '„Ç±', l: '„Åë' }, { a: '„Ç≥', l: '„Åì' },
            { a: '„Çµ', l: '„Åï' }, { a: '„Ç∑', l: '„Åó' }, { a: '„Çπ', l: '„Åô' }, { a: '„Çª', l: '„Åõ' }, { a: '„ÇΩ', l: '„Åù' },
            { a: '„Çø', l: '„Åü' }, { a: '„ÉÅ', l: '„Å°' }, { a: '„ÉÑ', l: '„Å§' }, { a: '„ÉÜ', l: '„Å¶' }, { a: '„Éà', l: '„Å®' },
            { a: '„Éä', l: '„Å™' }, { a: '„Éã', l: '„Å´' }, { a: '„Éå', l: '„Å¨' }, { a: '„Éç', l: '„Å≠' }, { a: '„Éé', l: '„ÅÆ' },
            { a: '„Éè', l: '„ÅØ' }, { a: '„Éí', l: '„Å≤' }, { a: '„Éï', l: '„Åµ' }, { a: '„Éò', l: '„Å∏' }, { a: '„Éõ', l: '„Åª' },
            { a: '„Éû', l: '„Åæ' }, { a: '„Éü', l: '„Åø' }, { a: '„É†', l: '„ÇÄ' }, { a: '„É°', l: '„ÇÅ' }, { a: '„É¢', l: '„ÇÇ' },
            { a: '„É§', l: '„ÇÑ' }, { a: '„É¶', l: '„ÇÜ' }, { a: '„É®', l: '„Çà' },
            { a: '„É©', l: '„Çâ' }, { a: '„É™', l: '„Çä' }, { a: '„É´', l: '„Çã' }, { a: '„É¨', l: '„Çå' }, { a: '„É≠', l: '„Çç' },
            { a: '„ÉØ', l: '„Çè' }, { a: '„É≤', l: '„Çí' }, { a: '„É≥', l: '„Çì' }
        ];

        const DAKUON_MIX = [
            { a: '„Åå', l: 'Ga' }, { a: '„Åé', l: 'Gi' }, { a: '„Åê', l: 'Gu' }, { a: '„Åí', l: 'Ge' }, { a: '„Åî', l: 'Go' },
            { a: '„Åñ', l: 'Za' }, { a: '„Åò', l: 'Ji' }, { a: '„Åö', l: 'Zu' }, { a: '„Åú', l: 'Ze' }, { a: '„Åû', l: 'Zo' },
            { a: '„Å†', l: 'Da' }, { a: '„Å¢', l: 'Ji' }, { a: '„Å•', l: 'Zu' }, { a: '„Åß', l: 'De' }, { a: '„Å©', l: 'Do' },
            { a: '„Å∞', l: 'Ba' }, { a: '„Å≥', l: 'Bi' }, { a: '„Å∂', l: 'Bu' }, { a: '„Åπ', l: 'Be' }, { a: '„Åº', l: 'Bo' },
            { a: '„Å±', l: 'Pa' }, { a: '„Å¥', l: 'Pi' }, { a: '„Å∑', l: 'Pu' }, { a: '„Å∫', l: 'Pe' }, { a: '„ÅΩ', l: 'Po' },
            { a: '„Ç¨', l: 'Ga(K)' }, { a: '„ÇÆ', l: 'Gi(K)' }, { a: '„Ç∞', l: 'Gu(K)' }, { a: '„Ç≤', l: 'Ge(K)' }, { a: '„Ç¥', l: 'Go(K)' },
            { a: '„Ç∂', l: 'Za(K)' }, { a: '„Ç∏', l: 'Ji(K)' }, { a: '„Ç∫', l: 'Zu(K)' }, { a: '„Çº', l: 'Ze(K)' }, { a: '„Çæ', l: 'Zo(K)' }
        ];

        const YOON_MIX = [
            { a: '„Åç„ÇÉ', l: 'Kya' }, { a: '„Åç„ÇÖ', l: 'Kyu' }, { a: '„Åç„Çá', l: 'Kyo' },
            { a: '„Åó„ÇÉ', l: 'Sha' }, { a: '„Åó„ÇÖ', l: 'Shu' }, { a: '„Åó„Çá', l: 'Sho' },
            { a: '„Å°„ÇÉ', l: 'Cha' }, { a: '„Å°„ÇÖ', l: 'Chu' }, { a: '„Å°„Çá', l: 'Cho' },
            { a: '„Å´„ÇÉ', l: 'Nya' }, { a: '„Å´„ÇÖ', l: 'Nyu' }, { a: '„Å´„Çá', l: 'Nyo' },
            { a: '„Å≤„É£', l: 'Hya' }, { a: '„Å≤„ÇÖ', l: 'Hyu' }, { a: '„Å≤„Çá', l: 'Hyo' },
            { a: '„Åø„É£', l: 'Mya' }, { a: '„Åø„ÇÖ', l: 'Myu' }, { a: '„Åø„Çá', l: 'Myo' },
            { a: '„Çä„É£', l: 'Rya' }, { a: '„Çä„ÇÖ', l: 'Ryu' }, { a: '„Çä„Çá', l: 'Ryo' }
        ];

        const VOCAB_POOL = [
            { a: '„ÅÇ„ÅÑ', l: 'Love' }, { a: '„ÅÜ„Åà', l: 'Up' }, { a: '„ÅÇ„Åä„ÅÑ', l: 'Blue' }, { a: '„ÅÑ„ÅÑ„Åà', l: 'No' }, { a: '„ÅØ„ÅÑ', l: 'Yes' },
            { a: '„Åã„Åä', l: 'Face' }, { a: '„Åç„Åè', l: 'Listen' }, { a: '„Åó„Çç', l: 'White' }, { a: '„ÅÇ„Åã', l: 'Red' }, { a: '„Çà„ÇÄ', l: 'Read' },
            { a: '„ÅÑ„Å¨', l: 'Dog' }, { a: '„Å®„Çä', l: 'Bird' }, { a: '„Åµ„ÇÜ', l: 'Winter' }, { a: '„Åè„ÇÇ', l: 'Cloud' }, { a: '„Åä„ÅØ„Çà„ÅÜ', l: 'Good Morning' },
            { a: '„Åõ„Çì„Åõ„ÅÑ', l: 'Teacher' }, { a: '„Åå„Åè„Åõ„ÅÑ', l: 'Student' }, { a: '„Å´„Åª„Çì', l: 'Japan' }, { a: '„Å°„ÇÖ„ÅÜ„Åî„Åè', l: 'China' },
            { a: '„Ç≥„Éº„Éí„Éº', l: 'Coffee' }, { a: '„Éì„Éº„É´', l: 'Beer' }, { a: '„Éà„Ç§„É¨', l: 'Toilet' }, { a: '„Éê„Çπ', l: 'Bus' }
        ];

        const PARTICLES_POOL = [
            { front: '„Çè„Åü„Åó', back: '„Åå„Åè„Åõ„ÅÑ „Åß„Åô„ÄÇ', ans: '„ÅØ', hint: 'Topic (I am...)' },
            { front: '„Åì„Çå', back: '„Åè„Å†„Åï„ÅÑ„ÄÇ', ans: '„Çí', hint: 'Object marker' },
            { front: '„Åå„Å£„Åì„ÅÜ', back: '„ÅÑ„Åç„Åæ„Åô„ÄÇ', ans: '„Å∏', hint: 'Direction (to)' },
            { front: '„Å®„Åó„Çá„Åã„Çì', back: '„Åπ„Çì„Åç„Çá„ÅÜ„Åó„Åæ„Åô„ÄÇ', ans: '„Åß', hint: 'Place of action (at)' }
        ];

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function createGrid(containerId, items, rows = 5) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            // Chunk into rows of 5
            for (let i = 0; i < items.length; i += 5) {
                const chunk = items.slice(i, i + 5);
                const rowDiv = document.createElement('div');
                rowDiv.className = 'grid-5';

                chunk.forEach(item => {
                    const box = document.createElement('div');
                    box.className = 'question-box';
                    box.dataset.answer = item.a;

                    box.innerHTML = `
                        <span class="label">${item.l}</span>
                        <input type="text">
                        <div class="ghost-answer">${item.a}</div>
                    `;
                    rowDiv.appendChild(box);
                });

                // Fill remaining spots if last row is incomplete
                while (rowDiv.children.length < 5) {
                    const empty = document.createElement('div');
                    empty.className = 'question-box bg-slate-50 border-none shadow-none';
                    rowDiv.appendChild(empty);
                }

                container.appendChild(rowDiv);
            }
        }

        function createVocabList(containerId, items) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            // Split into 2 columns
            const mid = Math.ceil(items.length / 2);
            const col1 = items.slice(0, mid);
            const col2 = items.slice(mid);

            [col1, col2].forEach(colItems => {
                const colDiv = document.createElement('div');
                colDiv.className = 'flex flex-col gap-2';
                colItems.forEach(item => {
                    const box = document.createElement('div');
                    box.className = 'question-box wide';
                    box.dataset.answer = item.a;
                    box.innerHTML = `
                         <span class="label">${item.l}</span>
                         <input type="text">
                         <div class="ghost-answer">${item.a}</div>
                     `;
                    colDiv.appendChild(box);
                });
                container.appendChild(colDiv);
            });
        }

        function createParticleQuestions(containerId, count) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const items = shuffle([...PARTICLES_POOL]).slice(0, count);

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-center gap-2 text-xl w-full';
                div.innerHTML = `
                    <span>${item.front}</span>
                    <div class="question-box border-none p-0 min-h-0 bg-transparent flex-row" data-answer="${item.ans}">
                        <input type="text" class="!w-12 border-b-2 border-slate-300 bg-transparent text-center" placeholder="?">
                        <div class="ghost-answer" style="position:static; margin-left:-30px; transform:none;">${item.ans}</div>
                    </div>
                    <span>${item.back}</span>
                    <span class="text-xs text-slate-400 ml-2">(${item.hint})</span>
                `;
                container.appendChild(div);
            });
        }

        function remixTest() {
            // Page 1: Hiragana A-Na (25 random)
            const p1 = shuffle([...HIRAGANA_BASIC].slice(0, 25)).slice(0, 25);
            createGrid('page-1-content', p1);

            // Page 2: Hiragana Ha-N (21 items + random fillers from first half to make 25)
            const remaining_h = HIRAGANA_BASIC.slice(25);
            const fillers_h = shuffle([...HIRAGANA_BASIC].slice(0, 25)).slice(0, 25 - remaining_h.length);
            const p2 = shuffle([...remaining_h, ...fillers_h]);
            createGrid('page-2-content', p2);

            // Page 3: Katakana A-No (25 random)
            const p3 = shuffle([...KATAKANA_BASIC].slice(0, 25)).slice(0, 25);
            createGrid('page-3-content', p3);

            // Page 4: Katakana Ha-N (+ fillers)
            const remaining_k = KATAKANA_BASIC.slice(25);
            const fillers_k = shuffle([...KATAKANA_BASIC].slice(0, 25)).slice(0, 25 - remaining_k.length);
            const p4 = shuffle([...remaining_k, ...fillers_k]);
            createGrid('page-4-content', p4);

            // Page 5: Dakuon Mix
            const p5 = shuffle([...DAKUON_MIX]).slice(0, 25);
            createGrid('page-5-content', p5);

            // Page 6: Yoon
            const p6 = shuffle([...YOON_MIX]).slice(0, 20); // 20 items = 4 rows
            createGrid('page-6-content', p6);

            // Page 7: Vocab
            const p7 = shuffle([...VOCAB_POOL]).slice(0, 14);
            createVocabList('page-7-content', p7);

            // Page 8: Particles
            createParticleQuestions('page-8-content', 3);

            // Re-apply current mode (if handwriting, generate canvases)
            setMode(currentMode);
        }

        // --- CORE FUNCTIONS (Mode, AI, Visual) ---

        const body = document.body;
        const btnTyping = document.getElementById('btn-typing');
        const btnWriting = document.getElementById('btn-writing');

        function setMode(mode) {
            currentMode = mode;
            body.className = 'mode-' + mode;
            if (mode === 'typing') {
                btnTyping.className = "px-3 py-1 rounded-lg text-sm font-bold bg-indigo-100 text-indigo-700 transition";
                btnWriting.className = "px-3 py-1 rounded-lg text-sm font-bold text-slate-400 hover:text-slate-600 transition";
            } else {
                btnWriting.className = "px-3 py-1 rounded-lg text-sm font-bold bg-indigo-100 text-indigo-700 transition";
                btnTyping.className = "px-3 py-1 rounded-lg text-sm font-bold text-slate-400 hover:text-slate-600 transition";
                // Delay slightly to allow DOM to settle if called immediately after generation
                setTimeout(() => {
                    document.querySelectorAll('.question-box').forEach(box => {
                        if (box.dataset.answer && !box.querySelector('canvas')) createCanvas(box);
                    });
                }, 50);
            }
        }

        function createCanvas(container) {
            // Avoid double creating or creating on fillers
            if (container.classList.contains('border-none') || !container.dataset.answer || container.querySelector('canvas')) return;

            const canvas = document.createElement('canvas');
            canvas.className = 'handwriting-canvas';
            container.appendChild(canvas);

            // Ensure sizing is correct
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;

            const ctx = canvas.getContext('2d');
            let isDrawing = false, lastX = 0, lastY = 0;

            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            const startDraw = (e) => {
                isDrawing = true;
                const { x, y } = getPos(e);
                lastX = x; lastY = y;
                canvas.dataset.hasDrawing = "true";
            };
            const draw = (e) => {
                if (!isDrawing) return;
                e.preventDefault(); // Stop scrolling on touch
                const { x, y } = getPos(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
                lastX = x; lastY = y;
            };
            const stopDraw = () => isDrawing = false;

            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('mouseout', stopDraw);
            canvas.addEventListener('touchstart', startDraw, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDraw);
        }

        function gradeVisual() {
            if (currentMode === 'typing') {
                let score = 0, count = 0;
                document.querySelectorAll('input').forEach(input => {
                    const box = input.closest('.question-box');
                    if (!box || !box.dataset.answer) return;
                    count++;
                    if (input.value.trim().toLowerCase() === box.dataset.answer.toLowerCase()) {
                        box.classList.add('correct-ai');
                        score++;
                    } else {
                        box.classList.add('incorrect-ai');
                    }
                });
                alert(`Score: ${score} / ${count}`);
            } else {
                document.querySelectorAll('.ghost-answer').forEach(ghost => {
                    ghost.style.opacity = '1';
                    ghost.style.color = 'rgba(239, 68, 68, 0.4)';
                });
            }
        }

        async function gradeWithAI() {
            if (currentMode !== 'handwriting') {
                alert("Available in Handwriting Mode.");
                return;
            }
            const loader = document.getElementById('ai-status-loader');
            const aiMsg = document.getElementById('ai-message');
            loader.style.display = 'block';
            aiMsg.classList.remove('hidden');
            aiMsg.innerText = "ü§ñ Ali AI is judging you...";
            
            // Clear previous icons and feedback
            document.querySelectorAll('.result-icon').forEach(el => el.remove());
            document.querySelectorAll('.ai-reason').forEach(el => el.remove());
            
            const canvases = document.querySelectorAll('canvas.handwriting-canvas');
            let correctCount = 0;
            let totalChecked = 0;
            
            // Ali AI (DashScope/Qwen) Configuration
            const ALI_API_KEY = "sk-89914a06e57d465a841b92d1ea15cdf0";
            const ALI_ENDPOINT = "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions";

            for(let canvas of canvases) {
                if(canvas.dataset.hasDrawing !== "true") continue;
                totalChecked++;
                const box = canvas.closest('.question-box');
                const expected = box.dataset.answer;
                const base64 = canvas.toDataURL('image/png'); // Keep data header for OpenAI format
                
                box.classList.add('checking');
                box.classList.remove('correct-ai', 'incorrect-ai'); 
                
                try {
                     const prompt = `
                        You are a Japanese teacher grading a student.
                        The student wrote the character: ${expected}.
                        
                        Rules:
                        1. PASS if the character is legible and correct (ignore bad balance or stroke order).
                        2. FAIL if it is a scribbled mess, crossed out, or unreadable.
                        3. FAIL if it is clearly the WRONG character.
                        
                        Return valid JSON:
                        { "pass": true/false, "reason": "Short reason (e.g. 'Too messy', 'Wrong shape')" }
                    `;

                    const res = await fetch(ALI_ENDPOINT, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${ALI_API_KEY}`
                        },
                        body: JSON.stringify({
                            model: "qwen-vl-max",
                            messages: [
                                {
                                    role: "user",
                                    content: [
                                        { type: "text", text: prompt },
                                        { type: "image_url", image_url: { url: base64 } }
                                    ]
                                }
                            ]
                        })
                    });
                    
                    const data = await res.json();
                    box.classList.remove('checking');
                    
                    if(data.error) throw new Error(data.error.message);
                    
                    let content = data.choices?.[0]?.message?.content || "{}";
                    // Clean json markdown if present
                    content = content.replace(/```json/g, '').replace(/```/g, '').trim();
                    
                    let result;
                    try {
                         result = JSON.parse(content);
                    } catch(e) {
                         // Fallback if AI returns non-json text
                         result = { 
                             pass: content.toLowerCase().includes('true') || content.toLowerCase().includes('pass'),
                             reason: content 
                         };
                    }

                    const icon = document.createElement('div');
                    icon.className = 'result-icon';
                    
                    if(result.pass) {
                        box.classList.add('correct-ai');
                        icon.innerText = '‚úÖ';
                        correctCount++;
                    } else {
                        box.classList.add('incorrect-ai');
                        icon.innerText = '‚ùå';
                        
                        const reason = document.createElement('div');
                        reason.className = 'ai-reason';
                        reason.innerText = result.reason || "Try again";
                        reason.style.cssText = "position:absolute; bottom:-20px; left:0; right:0; text-align:center; font-size:10px; color:#ef4444; background:white; padding:2px; border-radius:4px; border:1px solid #ef4444; box-shadow:0 2px 4px rgba(0,0,0,0.1); z-index:30;";
                        box.appendChild(reason);

                        const ghost = box.querySelector('.ghost-answer');
                        if(ghost) {
                            ghost.style.opacity = '1';
                            ghost.style.color = 'rgba(239, 68, 68, 0.4)';
                        }
                    }
                    box.appendChild(icon);
                    
                } catch(e) {
                    console.error("AI Error", e);
                    box.classList.remove('checking');
                    alert(`AI Error: ${e.message}`);
                }
                
                await new Promise(r => setTimeout(r, 600)); 
            }
            
            loader.style.display = 'none';
            aiMsg.classList.add('hidden');
            
            if(totalChecked > 0) {
                 setTimeout(() => alert(`Teacher says:\n‚úÖ Passed: ${correctCount}\n‚ùå Needs Work: ${totalChecked - correctCount}`), 500);
            }
        }          

            // Initialize
            remixTest();
    </script>
</body>

</html>